#!/bin/sh
export PULSE_SINK='alsa_output.pci-0000_00_14.2.analog-stereo'
EXPECTED_PORT='analog-output-headphones'

t_i="`date +%s`"
mode=0
n_keyboards="`lsusb -v 2>/dev/null|grep Keyboard|wc -l`"
#while [ "`tty`" != '?' ]; do
while :; do
	mpv="`/bin/showpath u=u ff=mpv standard`"
	msg=/usr/share/sounds/freedesktop/stereo/dialog-warning.oga
	lssinks="`/bin/showpath u=u ff=lssinks standard`"
	speaker="`"$lssinks"|head -1|awk '{print $1}'`"

	case "`date +%d`" in
	28)
		case "`date +%m`" in
		02)
			divisor=5
			;;
		*)
			divisor=4
		esac
		;;
	29)
		divisor=5
		;;
	*)
		divisor=4
	esac

	# set correct port - FIXME: this should only be done if Linux
	if is-at-home; then
		pa-set-sink-port $PULSE_SINK $EXPECTED_PORT
		nmcli d|grep wlan0|grep -w connected >/dev/null && nmcli device disconnect wlan0
	fi

	# set correct monitor orientation - FIXME: this should only be done if Linux
	if is-at-home; then
# unrotated: HDMI-0 connected 1920x1080+1366+0 (normal left inverted right x axis y axis) 527mm x 296mM
# rotated: HDMI-0 connected 1080x1920+1366+0 left (normal left inverted right x axis y axis) 527mm x 296mM
		if xrandr|grep HDMI-0|grep 'normal left inverted' >/dev/null; then
			something_done=no
			native_res="`xrandr|sed -e '1,/^HDMI-0/d'|head -1|awk '{print $1}'`"
			if xrandr|grep HDMI-0|grep 'left .normal' >/dev/null; then
				:
			else
				xrandr --output HDMI-0 --rotate left
				something_done=yes
			fi
			if xrandr|grep HDMI-0|grep -w "$native_res" >/dev/null; then
				:
			else
				xrandr --output HDMI-0 --mode $native_res
			fi
			if grep closed /proc/acpi/button/lid/LID/state >/dev/null; then
				if xrandr|grep eDP|grep 'left .normal' >/dev/null; then
					# for some reason turning this off makes the system super slow
					# so don't do it
					#xrandr --output eDP --off
					:
				fi
				if xrandr|grep eDP|grep primary >/dev/null; then
					xrandr --output HDMI-0 --primary
					# it's very strange. if we just define HDMI as primary
					# nothing happens. we actually have to turn it off first,
					# then turn it back on (see above), then define it as primary
					xrandr --output eDP --off
					sleep 10
					xrandr --output HDMI-0 --primary
					# force it to be narrower than the real monitor
					xrandr --output eDP --mode 1024x768
					something_done=yes
				fi
			else
				if xrandr|grep eDP|grep 'left .normal' >/dev/null; then
					:
				else
					xrandr --output eDP --auto
					xrandr --output eDP --primary
					something_done=yes
				fi
			fi
			if [ $something_done = yes ]; then
				xscreensaver-command -restart
			fi
		fi
	fi

	# load esound as a system daemon, but only when at home
	modules='module-esound-protocol-tcp module-native-protocol-tcp module-rtp-recv'
	if is-at-home; then
		for module in $modules; do
		case "$module" in
		*-protocol-tcp)
			opts='auth-ip-acl=127.0.0.1;192.168.0.0/24 auth-anonymous=1'
			;;
		module-rtp-recv)
			opts='sink=alsa_output.pci-0000_00_14.2.analog-stereo'
			;;
		esac
		(pacmd list-modules|grep -q "$module") || (set -x; pacmd load-module "$module" "$opts" &)
		done
	else
		for module in $modules; do
		(pacmd list-modules|grep -q "$module") && (set -x; pacmd unload-module "$module")
		done
	fi

	# try to detect new keyboards - XXX THIS IS DANGEROUS if any key is pressed while xmodmap does its thing
	n_keyboards_new="`lsusb -v 2>/dev/null|grep Keyboard|wc -l`"
	if [ -z "$n_keyboards" ] || [ "$n_keyboards_new" -gt "$n_keyboards" ]; then
		# FIXME we also need to reset mousekeys but I don't know how to do it
		fix-xmodmap
		n_keyboards="$n_keyboards_new"
	elif [ "$n_keyboards_new" -lt "$n_keyboards" ]; then
		n_keyboards="$n_keyboards_new"
	fi

	# kill unwanted programs
	killall update-manager >/dev/null 2>&1

	# detect sysline refresh interval
	dt="`ps x|grep 'sysline.*+[0-9]'|sed -e 's/.*+\([0-9][0-9]*\).*/\1/'|sort -n|head -1`"
	test -n "$dt" || dt=60

	# detect NFS server crash
	grep -w nfs /etc/fstab|cut -d: -f1|sort|uniq | while read a; do
		nfsup "$a" >/dev/null || paplay --volume 16384 /software/sndkit/data/wav/alarm.wav
	done

	t="`date +%s`"
	tmp="`expr "$dt" - "$t" % "$dt"`"
	t_next="`expr "$t" + "$tmp"`"
	(
	case "$mode" in
	0)
		printf '['
		det="`ip -o addr	|grep -w inet \
					|grep ': e' \
					|awk '{print $2, $4}' \
					|cut -d/ -f1 \
					|sed -e 's/ /: /g'`"
		if [ -n "$det" ]; then
			printf '%s | ' "$det"
		fi
		det="`iwgetid -r`"
		if [ -n "$det" ]; then
			ip -o addr	|grep -w inet \
					|grep ': w' \
					|awk '{print $2, $4}' \
					|cut -d/ -f1 \
					|sed -e 's/ /: /g'
			printf '%s | ' "$det"
		fi
		batt	|tr -d \\n \
			|sed -e 's/ (.*)//g' -e 's/, Charging/↑/g' -e 's/, Discharging\(, input [0-9\.]\+ V\)\?/↓/g' -e 's/, Full/ ⏸/g' -e 's/, input / ⏦/g' -e 's/ temp / /g'
		printf '] '
		;;
	1)
		det="`foocal -M -p all --iconic -w`"
		test -n "$det" && printf '[%s]' "$det"
		;;
	2)
		printf "[%s]" "`temps -s`"
		;;
#	3)
#		df  -P -m|awk '{print $1 "\t" $5 "\t" $4}'|grep /dev\\\|:|sort -k2 -r -n|uniq
#		;;
	3)
		if [ -n "` /usr/local/sbin/mailq`" ]; then
			echo 'You have unsent mail'
			[ -n "$mpv" -a -f "$msg" ] && "$mpv" --volume 100 "$msg" >/dev/null 2>&1
		fi
		if [ -n "$DISPLAY" ] && [ -z "`xlsclients|grep ' evolution$'`" ]; then
			echo "Evolution is not running"
			[ -n "$mpv" -a -f "$msg" ] && "$mpv" --volume 100 "$msg" >/dev/null 2>&1
		fi
		;;
	4)
		printf 'PAY PHONE BILL TODAY'
		;;
	esac
	) > $HOME/.who
	t="`date +%s`"
	dt="`expr "$t_next" - "$t"`"
	test -n "$dt" && test 1 -le "$dt" && sleep "$dt"
	mode="`expr \( "$mode" + 1 \) % $divisor`"
done
